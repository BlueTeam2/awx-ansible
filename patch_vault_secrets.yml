- name: Vault configuration
  hosts: localhost
  become: no
  tasks:
    - name: Gather ip's from necessary hosts
      setup:
      delegate_to: "{{ item }}"
      delegate_facts: True
      when: hostvars[item]['public_ip'] is not defined
      with_items: "{{ groups['env_'+envirnoment] }}"

    - name: Get info of an postgres instance
      gcp_sql_instance_info:
        project: "{{ lookup('ansible.builtin.env', gcp_project_env)  }}"
        auth_kind: serviceaccount
      register: sql_instances

    - name: Set secret to upage
      ansible.builtin.set_fact:
        postgres_to_update:
          ip: |-
              {{ 
                sql_instances.resources |
                selectattr('settings.userLabels.app', 'defined') |
                selectattr('settings.userLabels.app', 'equalto', 'schedule') |
                selectattr('settings.userLabels.env', 'equalto', envirnoment) |
                map(attribute='ipAddresses') |
                flatten |
                selectattr('type', 'equalto', 'PRIMARY') |
                map(attribute='ipAddress') |
                first
              }}
        mongodb_to_update:
          url: "{{ hostvars[groups['service_mongodb'] | first]['public_ip'] }}"
        nexus_to_update:
          ip: "{{ hostvars[groups['service_nexus'] | first]['public_ip'] }}"


    - name: Read current mongodb secret from the vault
      community.hashi_vault.vault_kv2_get:
        url: "{{ hashicorp_vault_server }}"
        auth_method: "approle"
        role_id: "{{ hashicorp_vault_approle_ansible_role_id }}"
        secret_id: "{{ hashicorp_vault_approle_ansible_secret_id }}"
        engine_mount_point: "{{ hashicorp_vault_application_mount_point }}"
        path: "{{ hashicorp_vault_mongodb_path }}"
      register: current_mongodb

    - name: Update mongodb ip in the vault
      community.hashi_vault.vault_kv2_write:
        url: "{{ hashicorp_vault_server }}"
        auth_method: "approle"
        role_id: "{{ hashicorp_vault_approle_ansible_role_id }}"
        secret_id: "{{ hashicorp_vault_approle_ansible_secret_id }}"
        engine_mount_point: "{{ hashicorp_vault_application_mount_point }}"
        path: "{{ hashicorp_vault_mongodb_path }}"
        data: >-
          {{ current_mongodb.secret | combine(mongodb_to_update) }}


    - name: Read current postgres secret from the vault
      community.hashi_vault.vault_kv2_get:
        url: "{{ hashicorp_vault_server }}"
        auth_method: "approle"
        role_id: "{{ hashicorp_vault_approle_ansible_role_id }}"
        secret_id: "{{ hashicorp_vault_approle_ansible_secret_id }}"
        engine_mount_point: "{{ hashicorp_vault_application_mount_point }}"
        path: "{{ hashicorp_vault_postgres_path }}"
      register: current_postgres

    - name: Update postgres ip in the vault
      community.hashi_vault.vault_kv2_write:
        url: "{{ hashicorp_vault_server }}"
        auth_method: "approle"
        role_id: "{{ hashicorp_vault_approle_ansible_role_id }}"
        secret_id: "{{ hashicorp_vault_approle_ansible_secret_id }}"
        engine_mount_point: "{{ hashicorp_vault_application_mount_point }}"
        path: "{{ hashicorp_vault_postgres_path }}"
        data: >-
          {{ current_postgres.secret | combine(postgres_to_update) }}


    - name: Read current nexus secret from the vault
      community.hashi_vault.vault_kv2_get:
        url: "{{ hashicorp_vault_server }}"
        auth_method: "approle"
        role_id: "{{ hashicorp_vault_approle_ansible_role_id }}"
        secret_id: "{{ hashicorp_vault_approle_ansible_secret_id }}"
        engine_mount_point: "{{ hashicorp_vault_nexus_mount_point }}"
        path: "{{ hashicorp_vault_nexus_path }}"
      register: current_nexus

    - name: Update nexus ip in the vault
      community.hashi_vault.vault_kv2_write:
        url: "{{ hashicorp_vault_server }}"
        auth_method: "approle"
        role_id: "{{ hashicorp_vault_approle_ansible_role_id }}"
        secret_id: "{{ hashicorp_vault_approle_ansible_secret_id }}"
        engine_mount_point: "{{ hashicorp_vault_nexus_mount_point }}"
        path: "{{ hashicorp_vault_nexus_path }}"
        data: >-
          {{ current_nexus.secret | combine(nexus_to_update) }}

    




