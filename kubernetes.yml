---
- name: Configure kubernetes cluster
  hosts: localhost
  gather_facts: false
  pre_tasks:
    - name: Activate service account
      ansible.builtin.shell: 
        cmd: |
          gcloud auth activate-service-account --key-file="${{ gcp_sa_env }}" --project "${{ gcp_project_env }}"
    
    - name: Generate kubeconfig to use kubeclt
      ansible.builtin.shell: 
        cmd: |
          gcloud container clusters get-credentials "{{ cluster_name }}" --zone "{{ cluster_zone }}" --project "${{ gcp_project_env }}"

  roles:
    - { role: deploy-app-to-kubernetes }
