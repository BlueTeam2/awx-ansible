---
- name: Configure kubernetes cluster
  hosts: localhost
  gather_facts: false
  tasks:
    - name: Generate kubeconfig to use kubeclt
      ansible.builtin.shell: 
        cmd: |
          gcloud auth activate-service-account --key-file="${{ gcp_sa_env }}" --project "${{ gcp_project_env }}"
    
    - name: Generate kubeconfig to use kubeclt
      ansible.builtin.shell: 
        cmd: |
          gcloud container clusters get-credentials "{{ cluster_name }}" --zone "{{ cluster_zone }}" --project "${{ gcp_project_env }}"


    - name: Add external-secrets repository
      kubernetes.core.helm_repository:
        repo_name: "{{ es_repo_name }}"
        repo_url: "{{ es_repo_url }}"

    - name: Deploy external-secrets chart
      kubernetes.core.helm:
        chart_ref: "{{ es_repo_name }}/{{ es_chart_name }}"
        create_namespace: true
        release_namespace: "{{ es_namespace }}"
        release_name: "{{ es_release_name }}"
        set_values: "{{ es_overwrite_values }}"

    - name: Git clone stable repo on HEAD
      ansible.builtin.git:
        repo: "{{ schedule_app_repo }}"
        dest: "{{ schedule_app_clone_dir }}"

    - name: Deploy backend
      kubernetes.core.helm:
        release_name: "{{ schedule_app_backend_name }}"
        chart_ref: "{{ schedule_app_clone_dir }}/{{ schedule_app_backend_name }}"
        release_namespace: "{{ schedule_app_namespace }}"
        create_namespace: true
        dependency_update: true
        set_values: "{{ schedule_app_backend_overwrite_values }}"

    - name: Deploy frontend
      kubernetes.core.helm:
        release_name: "{{ schedule_app_frontend_name }}"
        chart_ref: "{{ schedule_app_clone_dir }}/{{ schedule_app_frontend_name }}"
        release_namespace: "{{ schedule_app_namespace }}"
        create_namespace: true
